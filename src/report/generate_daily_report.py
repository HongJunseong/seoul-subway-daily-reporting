# src/report/generate_daily_report.py

from __future__ import annotations

import sys
import json
from pathlib import Path
from datetime import datetime
from dotenv import load_dotenv
import os

import pandas as pd  # ë‚˜ì¤‘ì— í•„ìš”í•˜ë©´, ì¼ë‹¨ ìˆì–´ë„ ë˜ê³  ì—†ì–´ë„ ë¨

CURRENT_FILE = Path(__file__).resolve()
PROJECT_ROOT = CURRENT_FILE.parents[2]
if str(PROJECT_ROOT) not in sys.path:
    sys.path.insert(0, str(PROJECT_ROOT))


load_dotenv(PROJECT_ROOT / ".env")

from src.report.build_report_context_daily import build_report_context

# ğŸ”‘ OpenAI / LLM í´ë¼ì´ì–¸íŠ¸ (ì˜ˆ: OpenAI ê³µì‹ í´ë¼ì´ì–¸íŠ¸)
from openai import OpenAI  # pip install openai>=1.0.0 í•„ìš”
openai_key = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=openai_key)  # í™˜ê²½ë³€ìˆ˜ OPENAI_API_KEY í•„ìš”


def build_prompt(target_ymd: str, ctx: dict) -> tuple[list[dict], str]:
    """
    LLMì— ë„˜ê¸¸ messagesì™€, ë‚˜ì¤‘ì„ ìœ„í•´ ì›ë³¸ JSON ë¬¸ìì—´ì„ ê°™ì´ ë°˜í™˜.
    """
    ctx_json = json.dumps(ctx, ensure_ascii=False, indent=2)

    system_msg = {
        "role": "system",
        "content": (
            "ë„ˆëŠ” ì„œìš¸ ì§€í•˜ì²  ë°ì´í„°ë¥¼ ë¶„ì„í•´ì„œ ì¼ê°„ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„±í•˜ëŠ” ë°ì´í„° ë¶„ì„ê°€ì´ë‹¤. "
            "ìˆ«ìë¥¼ ë‹¨ìˆœ ë‚˜ì—´í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼, íŒ¨í„´ê³¼ ì˜ë¯¸ë¥¼ í•´ì„í•´ì„œ ê¸€ë¡œ í’€ì–´ë‚´ì•¼ í•œë‹¤. "
            "í†¤ì€ ì¹¨ì°©í•˜ê³  ì„¤ëª… ì˜í•˜ëŠ” ë°ì´í„° ë¶„ì„ê°€ ëŠë‚Œìœ¼ë¡œ, ê³¼ì¥ ì—†ì´ ì‚¬ì‹¤ ìœ„ì£¼ë¡œ ì“°ë˜, "
            "ì¤‘ìš”í•œ í¬ì¸íŠ¸ëŠ” ê°•ì¡°í•´ì¤€ë‹¤. ë‹µë³€ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•œë‹¤."
        ),
    }

    user_msg = {
        "role": "user",
        "content": f"""
    ì•„ë˜ëŠ” {target_ymd} ê¸°ì¤€ ì„œìš¸ ì§€í•˜ì²  í†µê³„ ë°ì´í„°ì´ë‹¤. (JSON í˜•ì‹)

    ```json
    {ctx_json}
    ì´ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œêµ­ì–´ë¡œ "ì„œìš¸ ì§€í•˜ì²  ì¼ê°„ ë¶„ì„ ë³´ê³ ì„œ"ë¥¼ ì‘ì„±í•´ì¤˜.

    ì „ì²´ ìŠ¤íƒ€ì¼ / ê¸¸ì´ ìš”êµ¬
    - ë‹¨ìˆœ ìš”ì•½ì´ ì•„ë‹ˆë¼, ë¶„ì„ ë³´ê³ ì„œ í˜•íƒœë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì¤˜.
    - ì „ì²´ ë¶„ëŸ‰ì€ ìµœì†Œ 800ì ì´ìƒ, ê°€ëŠ¥í•˜ë©´ 1,500ì ì•ˆíŒìœ¼ë¡œ ì¨ì¤˜.
    - ê° ì§€í‘œ(ìŠ¹í•˜ì°¨, ëŒ€ê¸°ì‹œê°„, 5ë¶„ ì´ìƒ ë¹„ìœ¨, active_trains ë“±)ëŠ” ë‹¨ìˆœ ìˆ«ì ë‚˜ì—´ì´ ì•„ë‹ˆë¼, "ë¬´ìŠ¨ ì˜ë¯¸ì¸ì§€"ê¹Œì§€ í•´ì„í•´ì„œ ì„¤ëª…í•´ì¤˜.
    - Bulletë§Œ ë‚˜ì—´í•˜ì§€ ë§ê³ , ë¬¸ì¥í˜• í•´ì„¤ê³¼ í•¨ê»˜ ì„ì–´ì„œ ì¨ì¤˜.

    í˜•ì‹ :
    ë‹¤ìŒê³¼ ê°™ì€ í° êµ¬ì¡°ë¥¼ ì‚¬ìš©í•´ì¤˜. (ì´ ì´ëª¨ì§€/ì„¹ì…˜ ì œëª©ì„ ê·¸ëŒ€ë¡œ ì¨ë„ ì¢‹ê³ , ì•½ê°„ë§Œ ë³€í˜•í•´ë„ ê´œì°®ì•„)

    ë§¨ ì•ì—, ì•„ë˜ì™€ ë¹„ìŠ·í•œ í˜•ì‹ì˜ ìš”ì•½ ë¸”ë¡ì„ ë„£ì–´ì¤˜:

    {target_ymd[:4]}-{target_ymd[4:6]}-{target_ymd[6:8]} ì„œìš¸ ì§€í•˜ì²  ì„œë¹„ìŠ¤ ìš”ì•½

    - ì¼ë°˜ í˜¼ì¡ë„(í‰ì†Œ ì´ìš©ëŸ‰ ê¸°ì¤€): â€¦
    - ì²´ê° ì§€ì—°(ëŒ€ê¸°ì‹œê°„ + ì´ìš©ëŸ‰): â€¦
    - ì—´ì°¨ ìš´í–‰ ì¸¡ë©´: â€¦
    ì²˜ëŸ¼ 3~5ì¤„ ì •ë„ì˜ bullet ìš”ì•½ì„ ë„£ì–´ì¤˜.

    ê·¸ ì•„ë˜ë¶€í„°ëŠ” ì„¹ì…˜ ë²ˆí˜¸ë¥¼ êµ¬ë¶„í•´ì„œ ì¨ì¤˜:

    - ìŠ¹í•˜ì°¨ ê¸°ì¤€ í˜¼ì¡ë„ (Usage)
    - ì‹¤ì‹œê°„ ë„ì°© ê¸°ì¤€ ì²´ê° í’ˆì§ˆ (Arrival)
    - ì‹¤ì‹œê°„ ìš´í–‰(ìœ„ì¹˜) ê¸°ì¤€ í˜¼ì¡/ë¶ˆê· í˜• (Position)
    - ì¢…í•© ì½”ë©˜íŠ¸ (í•œ ì¤„ ì´í‰)

    ê° ì„¹ì…˜ì—ëŠ” ë‹¤ìŒ ë‚´ìš©ì„ í¬í•¨í•´ì¤˜.

    1ï¸. ìŠ¹í•˜ì°¨ ê¸°ì¤€ í˜¼ì¡ë„ (Usage)
    usage.top_stations_by_total ì„ í™œìš©í•´ì„œ TOP 10 ì—­ì„ ì„œìˆ ì‹ + bulletë¡œ ì •ë¦¬í•´ì¤˜.
    ì˜ˆì‹œ ìŠ¤íƒ€ì¼:
    - í™ëŒ€ì…êµ¬ (2í˜¸ì„ ) â€“ ì•½ 13.6ë§Œ ëª… â€“ 1ìœ„
    - ì ì‹¤(ì†¡íŒŒêµ¬ì²­) (2í˜¸ì„ ) â€“ ì•½ 13.4ë§Œ ëª… â€“ 2ìœ„
    ì´ëŸ° ì‹ìœ¼ë¡œ ì—­ëª… / ë…¸ì„  / ìŠ¹í•˜ì°¨ ì¸ì› / ìˆœìœ„ë¥¼ í•¨ê»˜ ì¨ì¤˜.
    ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ì„¤ëª…í•´ì¤˜

    usage.line_usage_stats ë¥¼ ì‚¬ìš©í•´ì„œ,

    1í˜¸ì„ , 2í˜¸ì„ , 9í˜¸ì„ , ê²½ë¶€ì„ , ë¶„ë‹¹ì„  ë“± í‰ê·  ì´ìš©ëŸ‰ì´ ë†’ì€ ë…¸ì„ ì„ ì¤‘ì‹¬ìœ¼ë¡œ
    "ì„œìš¸/ìˆ˜ë„ê¶Œ ì¶œí‡´ê·¼ ë©”ì¸ ì¶•" ê°™ì€ ì‹ìœ¼ë¡œ í•´ì„ì„ ë¶™ì—¬ì¤˜.
    ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ì„¤ëª…í•´ì£¼ë©´ ì¢‹ê² ì–´.

    ë§ˆì§€ë§‰ì— í•œë‘ ì¤„ ì •ë„ë¡œ
    "2í˜¸ì„  + ê²½ë¶€ì„  ì¶•ì´ í•µì‹¬ ì¶•ì´ë‹¤"ì²˜ëŸ¼ ì¶•/ë²¨íŠ¸ ê´€ì ì˜ í•œ ì¤„ ì •ë¦¬ë¥¼ ë„£ì–´ì¤˜.
    ì˜ˆì‹œë¥¼ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ì§€ ë§ê³ , ì˜¤ëŠ˜ ë°ì´í„°ì— ë§ê²Œ ìƒˆë¡œ ì‘ì„±í•´ì¤˜.

    2. ì‹¤ì‹œê°„ ë„ì°© ê¸°ì¤€ ì²´ê° í’ˆì§ˆ (Arrival)
    arrival.line_wait_stats, arrival.painful_stations, arrival.last_train_info, arrival.late_night_hotspots ë¥¼ í™œìš©í•´ì„œ:
    ë…¸ì„ ë³„ í‰ê·  ëŒ€ê¸°ì‹œê°„(avg_wait_sec)ê³¼ 5ë¶„ ì´ìƒ ëŒ€ê¸° ë¹„ìœ¨(long_wait_ratio_5)ì„
    1í˜¸ì„ , 2í˜¸ì„ , 3í˜¸ì„ , 4í˜¸ì„ , 5Â·6Â·7Â·9í˜¸ì„ , ìš°ì´ì‹ ì„¤ì„ (1092) ìœ„ì£¼ë¡œ ë¹„êµí•´ì¤˜.
    ì˜ˆ: "2í˜¸ì„ ì€ í‰ê·  8ë¶„ ì´ìƒ, 5ë¶„ ì´ìƒ ëŒ€ê¸° ë¹„ìœ¨ 66%ë¡œ ì²´ê° ì§€ì—°ì´ í° í¸" ì‹ìœ¼ë¡œ ì„œìˆ í•´ì¤˜.
    ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ì„¤ëª…í•´ì¤˜.

    arrival.painful_stations ë¥¼ ì´ìš©í•´ì„œ
    ë°ì´í„°ë¥¼ ê¼¼ê¼¼íˆ í™•ì¸í•˜ë©´ì„œ ì˜ˆë¥¼ ë“¤ì–´ ê±´ëŒ€ì…êµ¬, í™ëŒ€ì…êµ¬, ê³ ì†í„°ë¯¸ë„, ì—°ì‹ ë‚´, ê°•ë‚¨, ì‹ ë¦¼, ì„ì§€ë¡œì…êµ¬, ì„±ìˆ˜ ë“±
    "ì‚¬ëŒë„ ë§ê³ , ì—´ì°¨ë„ ëŠ¦ê²Œ ì˜¤ëŠ” ì—­"ì„ TOP 5~10ê°œ ì •ë„ ë½‘ì•„ì„œ
    ë˜í•œ, ê° ì—­ë§ˆë‹¤ í‰ê·  ëŒ€ê¸°ì‹œê°„ + 5ë¶„ ì´ìƒ ë¹„ìœ¨ + ìŠ¹í•˜ì°¨ ì¸ì›ì„ ê°™ì´ ì„¤ëª…í•´ì¤˜.
    ì˜ˆì‹œë¥¼ ë”°ë¼í•˜ì§€ ë§ê³ , ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ì„¤ëª…í•´ì¤˜.


    arrival.last_train_info, late_night_hotspots ë¥¼ í™œìš©í•´ì„œ
    ë§‰ì°¨ê°€ ëŠ¦ê²Œê¹Œì§€ ìš´í–‰ëœ êµ¬ê°„(ì˜ˆ: ì¸ì²œ, íŒŒì£¼, ì •ë¶€ê³¼ì²œì²­ì‚¬ ë“±)ê³¼
    ì‹¬ì•¼ ìš´í–‰ì´ ë§ì€ ë„ì‹¬/í™˜ìŠ¹ì—­(ì²­ëŸ‰ë¦¬, ì œê¸°ë™, ì‚¬ë‹¹, ë¶ˆê´‘ ë“±)ì„
    "ì•¼ê°„ ìš´í–‰ íŒ¨í„´" ê´€ì ì—ì„œ ì„¤ëª…í•´ì¤˜.

    3. ì‹¤ì‹œê°„ ìš´í–‰(ìœ„ì¹˜) ê¸°ì¤€ í˜¼ì¡/ë¶ˆê· í˜• (Position)
    position.line_overall, position.peak_stats, position.direction_asymmetry ë¥¼ í™œìš©í•´ì„œ:
    ë™ì‹œì— ì›€ì§ì´ëŠ” ì—´ì°¨ ìˆ˜ê°€ ë§ì€ ë…¸ì„ :
    ì˜ˆë¥¼ ë“¤ì–´ 9í˜¸ì„ , 2í˜¸ì„ , 5í˜¸ì„ , 1Â·3Â·4Â·7í˜¸ì„  ë“±
    "ë™ì‹œì— ëª‡ ëŒ€ê°€ ì›€ì§ì˜€ëŠ”ì§€(í‰ê· /ìµœëŒ€)"ë¥¼ ì“°ê³ ,
    "ê·¸ë§Œí¼ ë°°ì°¨ê°€ ì´˜ì´˜í•˜ê±°ë‚˜, ìˆ˜ìš”ê°€ ì§‘ì¤‘ëœ êµ¬ê°„"ì´ë¼ëŠ” í•´ì„ì„ ë¶™ì—¬ì¤˜.
    ì˜ˆì‹œë¥¼ ë”°ë¼í•˜ì§€ë§ê³ , ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ë§í•´ì¤˜.

    direction_asymmetry ë¥¼ í™œìš©í•´ì„œ
    9í˜¸ì„ , 1Â·2Â·3Â·6Â·7í˜¸ì„  ë“±ì˜ **ìƒÂ·í•˜í–‰ ë¶ˆê· í˜•(gap)**ì„ ì„¤ëª…í•´ì¤˜.
    ì˜ˆ: "9í˜¸ì„ ì€ ìƒí–‰ 13ëŒ€ vs í•˜í–‰ 8ëŒ€ë¡œ ê°­ 5ëŒ€ â†’ íŠ¹ì • ë°©í–¥ìœ¼ë¡œ ìˆ˜ìš” ì ë¦¼"
    ì˜ˆì‹œ ë”°ë¼í•˜ì§€ë§ê³ , ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ë§í•´ì¤˜.

    ë°ì´í„°ë¥¼ ë³´ê³  ë°°ì°¨ì˜ balanceê°€ ì¢‹ì€ ë…¸ì„ ì€
    "ë°°ì°¨ê°€ ê· í˜•ì ìœ¼ë¡œ ìœ ì§€ë˜ëŠ” ë…¸ì„ "ì´ë¼ëŠ” ì‹ìœ¼ë¡œ ì½”ë©˜íŠ¸í•´ì¤˜.

    4. ì¢…í•© ì½”ë©˜íŠ¸ (í•œ ì¤„ ì´í‰)
    ë§ˆì§€ë§‰ì— 3~5ì¤„ ì •ë„ë¡œ, ì˜¤ëŠ˜ ë°ì´í„°ë¥¼ í•œ ë²ˆ ë” ì••ì¶•í•´ì„œ ì •ë¦¬í•´ì¤˜.
    ì˜ˆë¥¼ ë“¤ë©´ ì´ëŸ° ëŠë‚Œìœ¼ë¡œ:

    â€œìµœê·¼ 4ì¼ ê¸°ì¤€ìœ¼ë¡œëŠ” 2í˜¸ì„ Â·ê²½ë¶€ì„  ì¶•(í™ëŒ€ì…êµ¬, ì ì‹¤, ê³ ì†í„°ë¯¸ë„, ê°•ë‚¨ ë“±)ì´ ì—¬ì „íˆ ìµœìƒìœ„ í˜¼ì¡ë„ë¥¼ ê¸°ë¡í•˜ê³  ìˆê³ ,
    ì˜¤ëŠ˜ ì‹¤ì‹œê°„ ë°ì´í„° ê¸°ì¤€ìœ¼ë¡œëŠ” 2Â·7Â·6Â·9í˜¸ì„  ì¼ë¶€ êµ¬ê°„ì—ì„œ í‰ê·  ëŒ€ê¸°ì‹œê°„ê³¼ 5ë¶„ ì´ìƒ ëŒ€ê¸° ë¹„ìœ¨ì´ ë†’ê²Œ ë‚˜íƒ€ë‚˜
    ê±´ëŒ€ì…êµ¬, í™ëŒ€ì…êµ¬, ê³ ì†í„°ë¯¸ë„, ê°•ë‚¨, ì‹ ë¦¼, ì—°ì‹ ë‚´ ê°™ì€ ì—­ë“¤ì´
    â€˜ë§ì´ íƒ€ë©´ì„œ ì˜¤ë˜ ê¸°ë‹¤ë¦¬ëŠ” ê³ í†µì—­â€™ìœ¼ë¡œ ë“œëŸ¬ë‚œë‹¤.
    ìš´í–‰ ì¸¡ë©´ì—ì„œëŠ” 9í˜¸ì„ ì´ ê°€ì¥ ë§ì€ ì—´ì°¨ê°€ ë™ì‹œì— ì›€ì§ì´ê³ , ìƒÂ·í•˜í–‰ ë¶ˆê· í˜•ë„ ê°€ì¥ ì»¤ì„œ
    íŠ¹ì • ë°©í–¥ìœ¼ë¡œì˜ ìˆ˜ìš” ì ë¦¼ê³¼ ë°°ì°¨ ì§‘ì¤‘ì´ ëšœë ·í•˜ê²Œ ë‚˜íƒ€ë‚œë‹¤.â€

    ìœ„ ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ì§€ ë§ê³ , ì˜¤ëŠ˜ ë°ì´í„°(ì…ë ¥ JSON)ì— ë§ì¶°ì„œ ë¹„ìŠ·í•œ ë°€ë„ì™€ í†¤ìœ¼ë¡œ ë°ì´í„°ì— ë§ê²Œ ìƒˆë¡œ ì‘ì„±í•´ì¤˜.
    ë˜í•œ ìœ„ì— ëª¨ë“  ë‚´ìš©ì— ëŒ€í•œ ì„¤ëª…ë“¤ì´ ì¢€ ë” ë°ì´í„°ì— ê·¼ê±°í•´ì„œ ì„¤ëª…ê¹Œì§€ êµ¬ì²´ì ìœ¼ë¡œ ë§ë¶™ì—¬ì§€ë©´ ì¢‹ê² ì–´.
    """,
    }

    messages = [system_msg, user_msg]
    return messages

def generate_daily_report(target_ymd: str | None = None) -> Path:
    if target_ymd is None:
        target_ymd = datetime.today().strftime("%Y%m%d")
    
    # 1) ì»¨í…ìŠ¤íŠ¸ ìƒì„±
    ctx = build_report_context(target_ymd)

    # 2) í”„ë¡¬í”„íŠ¸ ìƒì„±
    messages = build_prompt(target_ymd, ctx)

    # 3) LLM í˜¸ì¶œ
    response = client.chat.completions.create(
        model="gpt-5-mini",  # ë˜ëŠ” ë„¤ê°€ ì“°ëŠ” ëª¨ë¸ëª…ìœ¼ë¡œ
        messages=messages,
        # temperature=0.3,
    )

    report_text = response.choices[0].message.content

    # 4) ê²°ê³¼ ì €ì¥ (ì˜ˆ: markdown)
    out_dir = PROJECT_ROOT / "data" / "report_text" / "daily"
    out_dir.mkdir(parents=True, exist_ok=True)
    out_path = out_dir / f"subway_report_{target_ymd}.md"

    out_path.write_text(report_text, encoding="utf-8")
    print(f"[INFO] Saved daily report: {out_path}")

    return out_path

def main():
    # ì˜¤ëŠ˜ ê¸°ì¤€
    generate_daily_report()

if __name__ == "__main__":
    main()